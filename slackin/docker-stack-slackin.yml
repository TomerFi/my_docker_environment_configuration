version: "3.7"

x-image-version:
  &image-version
  image: tomerfi/slackin_docker:latest
  
x-restart-policy:
  &restart-policy
  restart_policy:
    condition: on-failure
    delay: 30s
    max_attempts: 3
    window: 30s

x-rollback-config:
  &rollback-config
  rollback_config:
    parallelism: 1
    delay: 30s
    failure_action: continue
    monitor: 60s
    max_failure_ratio: 1
    order: stop-first

x-update-config:
  &update-config
  update_config:
    parallelism: 1
    delay: 30s
    failure_action: pause
    monitor: 60s
    max_failure_ratio: 1
    order: stop-first

networks:

  tomfi_slackin_net:
    driver: overlay
    labels:
      info.tomfi.schemas.docker.network.name: "Slackin network."
      info.tomfi.schemas.docker.network.description: "Use for segregating slackin instances."
    name: tomfi_slackin_net
    driver_opts:
      com.docker.network.driver.mtu: 1400

services:

  aioswitcher:
    <<: *image-version
    init: true
    env_file: env/.env_slack
    environment:
      - SLACK_CHANNELS=aioswitcher
    ports:
      - target: 8000
        published: 6875
        protocol: tcp
        mode: host
    networks:
      tomfi_slackin_net:
    labels:
      info.tomfi.schemas.docker.container.name: "Slackin aioswitcher."
      info.tomfi.schemas.docker.container.description: "Slackin instance for aioswitcher repository."
    deploy:
      endpoint_mode: vip
      mode: replicated
      replicas: 1
      labels:
        info.tomfi.schemas.docker.service.name: "Slackin aioswitcher."
        info.tomfi.schemas.docker.service.description: "Slackin instance for aioswitcher repository."
      placement:
        constraints: 
          - node.hostname == docker_station
      <<: *restart-policy
      <<: *rollback-config
      <<: *update-config

  slackin_docker:
    <<: *image-version
    init: true
    env_file: env/.env_slack
    environment:
      - SLACK_CHANNELS=slackin_docker
    ports:
      - target: 8000
        published: 6876
        protocol: tcp
        mode: host
    networks:
      tomfi_slackin_net:
    labels:
      info.tomfi.schemas.docker.container.name: "Slackin slackin_docker."
      info.tomfi.schemas.docker.container.description: "Slackin instance for slackin_docker repository."
    deploy:
      endpoint_mode: vip
      mode: replicated
      replicas: 1
      labels:
        info.tomfi.schemas.docker.service.name: "Slackin slackin_docker."
        info.tomfi.schemas.docker.service.description: "Slackin instance for slackin_docker repository."
      placement:
        constraints: 
          - node.hostname == docker_station
      <<: *restart-policy
      <<: *rollback-config
      <<: *update-config

  switcher_webapi:
    <<: *image-version
    init: true
    env_file: env/.env_slack
    environment:
      - SLACK_CHANNELS=switcher_webapi
    ports:
      - target: 8000
        published: 6877
        protocol: tcp
        mode: host
    networks:
      tomfi_slackin_net:
    labels:
      info.tomfi.schemas.docker.container.name: "Slackin switcher_webapi."
      info.tomfi.schemas.docker.container.description: "Slackin instance for switcher_webapi repository."
    deploy:
      endpoint_mode: vip
      mode: replicated
      replicas: 1
      labels:
        info.tomfi.schemas.docker.service.name: "Slackin switcher_webapi."
        info.tomfi.schemas.docker.service.description: "Slackin instance for switcher_webapi repository."
      placement:
        constraints: 
          - node.hostname == docker_station
      <<: *restart-policy
      <<: *rollback-config
      <<: *update-config